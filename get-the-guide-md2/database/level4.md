## DB 아키텍처 수준: Level 4.DBMS per Service & Event Sourcing, CQRS

### 전환 원칙
- **이벤트 기반 데이터 관리**: 이벤트 중심 아키텍처를 구축하여 각 마이크로서비스 간의 데이터 흐름을 이벤트 기반으로 관리합니다.
- **이벤트 소싱 및 커맨드-쿼리 분리(CQRS)**: 이벤트 소싱을 통해 시스템의 상태를 재생하고, 커맨드와 쿼리를 분리하여 비동기적인 데이터 처리를 구현합니다.
- **데이터 일관성 관리**: 일시적으로 데이터에 일관성이 없는 상태가 발생할 수 있으며, 이를 일정 시간 내에 해소하여 다시 일관성을 충족시키는 메커니즘을 구현합니다.

### 전환 절차
#### 전환 평가(Assess)
- 기존 시스템의 데이터 관리 및 처리 방식을 분석하여, 이벤트 소싱과 CQRS를 도입할 때의 장단점을 평가합니다.
- 서비스별 데이터 요구사항과 트랜잭션 처리 방식을 식별하고, 이벤트 소싱 및 CQRS 도입의 적합성을 검토합니다.

> **요약 :** 전환 평가 단계에서는 이벤트 소싱과 CQRS 도입의 타당성을 분석하고, 시스템의 현재 상태와 전환 후 기대되는 이점을 평가합니다.

#### 마이그레이션 준비
- 전환을 위해 필요한 기술 스택, 도구 및 인프라를 선택합니다. 이벤트 스토어, CQRS 프레임워크, 메시지 브로커 등의 도구 선택이 포함됩니다.
- 데이터 모델링과 마이그레이션 계획을 수립하고, 이벤트 소싱 및 CQRS 적용을 위한 초기 설정 작업을 계획합니다.

> **요약 :** 마이그레이션 준비 단계에서는 이벤트 소싱 및 CQRS 적용을 위한 기술적 준비와 계획을 세웁니다.

#### 전환 계획(Plan) 수립
- **세부 실행 계획**: 각 마이크로서비스별로 이벤트 소싱과 CQRS를 도입하기 위한 세부 실행 계획을 수립합니다. 이 과정에서는 각 서비스의 기능 분해, 이벤트 모델링, 명령과 쿼리의 분리 등을 상세히 계획합니다.
- **리스크 관리**: 전환 과정에서 발생할 수 있는 리스크를 식별하고, 대응 계획을 수립합니다. 데이터 마이그레이션, 시스템 성능 저하, 데이터 일관성 문제 등이 주요 리스크 요인으로 고려됩니다.
- **팀 구성 및 교육**: 전환을 실행할 개발 팀을 구성하고, 이벤트 소싱과 CQRS에 대한 교육 및 워크샵을 실시하여 팀원들의 이해도를 높입니다.

> **요약 :** 전환 계획 단계에서는 각 마이크로서비스에 이벤트 소싱과 CQRS를 적용하기 위한 세부 계획을 수립하며, 리스크 관리와 팀 준비에 중점을 둡니다. 이 단계는 전환의 성공적인 실행을 위한 기반을 마련합니다.

#### 전환 설계(Design)
- **이벤트 모델링 및 시스템 설계**: 각 마이크로서비스의 도메인 이벤트를 식별하고 모델링합니다. 이벤트 소싱과 CQRS 패턴을 적용한 시스템 아키텍처를 설계하며, 이벤트 저장소, 명령 핸들러, 쿼리 모델을 구현하는 방법을 정의합니다.
- **데이터 마이그레이션 전략**: 기존 시스템에서 새로운 아키텍처로의 데이터 마이그레이션 전략을 수립합니다. 이 과정에서는 이벤트 소싱을 위한 이벤트 로그의 초기 적재, 기존 데이터를 쿼리 모델로 변환하는 방법 등을 고려합니다.
- **성능 및 확장성 고려**: 설계 과정에서 시스템의 성능과 확장성을 고려합니다. 이벤트 처리량, 데이터 접근 속도, 시스템의 확장 용이성 등을 평가하고 최적화합니다.

> **요약 :** 전환 설계 단계에서는 이벤트 소싱과 CQRS 패턴을 적용한 시스템의 아키텍처를 설계하며, 데이터 마이그레이션 전략과 시스템의 성능, 확장성을 고려한 설계를 진행합니다.

#### 마이그레이션(Migration)
- **이벤트 스토어 및 DBMS 구축**: 전환 설계에서 결정된 각 마이크로서비스에 맞춰 이벤트 스토어와 DBMS를 구축합니다. 각 서비스의 요구사항에 맞는 DBMS(예: 관계형 데이터베이스, NoSQL 등)를 선택하고, 이벤트 소싱을 위한 이벤트 스토어를 준비합니다. 폴리글랏 퍼시스턴스 접근 방식을 채택하여, 서비스별로 최적의 데이터 저장 기술을 적용합니다.
- **데이터 마이그레이션 및 이벤트 로그 초기화**: 기존 시스템에서 새로운 아키텍처로 데이터를 마이그레이션합니다. 이 과정에서 기존 데이터를 기반으로 초기 이벤트 로그를 생성하고, 새로운 쿼리 모델을 위한 데이터를 준비합니다. 데이터의 일관성과 무결성을 유지하기 위한 철저한 계획과 검증 과정을 거칩니다.
- **시스템 통합 및 테스트**: 새롭게 마이그레이션된 시스템의 각 컴포넌트가 올바르게 통합되었는지 확인합니다. 이벤트 소싱 및 CQRS 구현이 기대한 대로 작동하는지 테스트하며, 전체 시스템의 성능, 확장성, 그리고 데이터 일관성을 검증합니다. 부하 테스트와 스트레스 테스트를 통해 시스템의 한계와 안정성을 평가합니다.
- **데이터 동기화 및 일관성 검증**: 마이크로서비스 간 데이터 동기화 메커니즘을 검증하고, 전체 시스템에서 데이터의 일관성을 유지하는지 확인합니다. 이벤트 소싱과 CQRS 패턴을 통해 시스템의 상태 변경이 모든 관련 서비스에 정확히 반영되고, 데이터 일관성이 유지되는지 철저히 테스트합니다.

> **요약 :** 마이그레이션 단계에서는 각 마이크로서비스에 맞춰 이벤트 스토어와 DBMS를 구축하고, 기존 시스템의 데이터를 새로운 아키텍처로 마이그레이션합니다. 이 과정에는 데이터 마이그레이션, 시스템 통합 및 테스트, 그리고 데이터 동기화 및 일관성 검증이 포함됩니다. 전체적으로 시스템의 안정성, 성능 및 데이터 일관성을 확보하기 위한 체계적인 접근이 필요합니다.

#### 전환 후 운영 최적화(Operate Optimize)
- **성능 모니터링 및 조정**: 새로운 아키텍처에 맞춰 성능 모니터링 도구를 설정하고, 시스템 전반의 성능 데이터를 지속적으로 수집합니다. 이 데이터를 분석하여 성능 병목 현상을 식별하고, 필요한 경우 시스템 구성이나 코드를 조정하여 최적의 성능을 달성합니다.
- **데이터 일관성 및 무결성 관리**: 이벤트 소싱과 CQRS를 통해 관리되는 데이터의 일관성과 무결성을 지속적으로 모니터링합니다. 시스템 내부 또는 외부에서 발생할 수 있는 다양한 이슈로부터 데이터 일관성을 보호하기 위한 메커니즘을 강화하고, 정기적인 데이터 검증 절차를 수행합니다.
- **자동화 및 인프라 관리**: 클라우드 네이티브 환경에서의 운영 효율성을 극대화하기 위해 배포, 모니터링, 로깅, 백업 등의 프로세스를 자동화합니다. 인프라스트럭처 코드(IaC)를 사용하여 인프라의 설정과 관리를 자동화하고, 변경 관리를 용이하게 합니다.
- **보안 강화 및 규정 준수**: 새로운 아키텍처와 기술 스택 도입으로 변경된 보안 요구 사항을 충족하기 위해 보안 정책과 절차를 재검토하고 강화합니다. 데이터 암호화, 접근 제어, 보안 취약점 관리 등을 포함하여, 전체 시스템의 보안 수준을 지속적으로 개선합니다. 또한, 관련 법률 및 규정 준수 사항을 확인하고 준수합니다.

> **요약 :** 전환 후 운영 최적화 단계에서는 시스템의 성능 모니터링 및 최적화, 데이터 일관성 및 무결성 관리, 운영 프로세스의 자동화 및 인프라 관리, 그리고 보안 강화 및 규정 준수를 통해 새로운 아키텍처에서의 안정적이고 효율적인 운영을 지원합니다. 이 단계는 시스템의 지속 가능한 성장과 변화에 유연하게 대응할 수 있는 기반을 마련합니다.

### References :
- 분산 환경에서의 최종 일관성(Eventual Transaction) 유지 - https://www.msaschool.io/operation/integration/integration-four/
- MSA 환경에서의 데이터 프로젝션(Data Projection) 기법 - https://www.msaschool.io/operation/integration/integration-five/
- Front-end에서의 데이터 통합 - https://www.msaschool.io/operation/integration/integration-one/
- 동기 호출(Request/Response Communication)에 의한 데이터 통합 - https://www.msaschool.io/operation/integration/integration-two/
- 이벤트 소싱(Event Sourcing) 기반 데이터 통합 - https://www.msaschool.io/operation/integration/integration-three/
- 커맨트 모델과 쿼리 모델의 분리(CQRS) - https://www.msaschool.io/operation/integration/integration-six/
- CQRS 데이터 프로잭션 - https://intro-kor.msaez.io/development/dp-cqrs/